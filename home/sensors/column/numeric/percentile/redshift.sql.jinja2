{% import '/dialects/redshift.sql.jinja2' as lib with context -%}

SELECT
    MAX(actual_value) AS actual_value, time_period, time_period_utc
FROM(
    SELECT
        PERCENTILE_CONT({{ parameters.percentile_value }}) WITHIN GROUP (ORDER BY {{ lib.render_target_column('analyzed_table')}}) AS actual_value
        {{- lib.render_data_stream_projections('analyzed_table') }}
        {{- lib.render_time_dimension_projection('analyzed_table') }}
    FROM {{ lib.render_target_table() }} AS analyzed_table
    {{- lib.render_where_clause(indentation = '    ') -}}
    {{- lib.render_group_by() -}}) AS nested_table
{{- lib.render_group_by() -}}
{{- lib.render_order_by() -}}