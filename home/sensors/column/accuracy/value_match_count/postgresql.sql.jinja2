{% import '/dialects/postgresql.sql.jinja2' as lib with context -%}

{%- macro render_joined_table() -%}
    {{ quote_identifier(connection.bigquery.source_project_id) }}.{{ quote_identifier(table.target.schema_name) }}.{{ quote_identifier(parameters.joined_table_name) }}
{%- endmacro %}

{%- macro render_joined_column(table_alias_prefix = '') -%}
    {{ table_alias_prefix }}.{{ quote_identifier(parameters.joined_column_name) }}
{%- endmacro %}


SELECT
    COUNT({{ lib.render_target_table() }}.{{ lib.render_target_column('analyzed_table')}})
    AS actual_value
    {{- lib.render_data_stream_projections('analyzed_table') }}
    {{- lib.render_time_dimension_projection('analyzed_table') }}
FROM {{ lib.render_target_table() }} AS analyzed_table
RIGHT OUTER JOIN {{ render_joined_table() }} AS joined_table
ON {{ lib.render_target_table() }}.{{ lib.render_target_column('analyzed_table')}} = {{ render_joined_table() }}.{{ render_joined_column('joined_table')}}
{{- lib.render_where_clause() -}}
{{- lib.render_group_by() -}}
{{- lib.render_order_by() -}}