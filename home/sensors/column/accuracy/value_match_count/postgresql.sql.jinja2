{% import '/dialects/postgresql.sql.jinja2' as lib with context -%}

{% macro quote_identifier(name) -%}
    {{ dialect_settings.quote_begin }}{{ name | replace(dialect_settings.quote_end, dialect_settings.quote_escape) }}{{ dialect_settings.quote_end }}
{%- endmacro %}

{%- macro render_joined_table(joined_tab) -%}
    {{ quote_identifier(connection.bigquery.source_project_id) }}.{{ quote_identifier(table.target.schema_name) }}.{{ quote_identifier(joined_tab) }}
{%- endmacro %}

{%- macro render_joined_column(table_alias_prefix = '') -%}
    {{ quote_identifier(parameters.joined_col) }}
{%- endmacro %}


SELECT
    COUNT({{ lib.render_target_column('analyzed_table')}})
    AS actual_value
    {{- lib.render_data_stream_projections('analyzed_table') }}
    {{- lib.render_time_dimension_projection('analyzed_table') }}
FROM {{ lib.render_target_table() }} AS analyzed_table
RIGHT OUTER JOIN {{ render_joined_table(parameters.joined_tab) }} AS joined_table
ON {{ lib.render_target_column('analyzed_table')}} = joined_table.{{ render_joined_column(parameters.joined_col) }}
{{- lib.render_where_clause() -}}
{{- lib.render_group_by() -}}
{{- lib.render_order_by() -}}